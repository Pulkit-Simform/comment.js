#!/usr/bin/env node
var path = require('path');
var utils = require('../lib/utils');
var Commentjs = require('../lib/comment');
var View = require('../lib/view');
var args = process.argv.slice(2);
var options = {};
var getOption = function (opt) {
  var index = args.indexOf(opt);
  var value;
  if (index >= 0) {
    value = args[index + 1];
    args.splice(index, 2);
  }
  return value;
};

var output = getOption('-o');
var commentjs, data, viewoptions, view;

if (output) {
  options.output = output;
}

if (!args.length) {
  utils.log.writeln();
  utils.log.writeln('Usage: commentjs <file1.js file2.js> or <path/> or <.json config file> [options]');
  utils.log.writeln();
  utils.log.writeln('   -o    set the output directory for the doc files');
  utils.log.writeln();
  utils.log.writeln('Example usage:');
  utils.log.writeln('   commentjs file1.js file2.js');
  utils.log.writeln('   commentjs js/ -o docs/index.html');
  utils.log.writeln('   commentjs config.json');
  utils.log.writeln();
  process.exit(1);

// .json config file
} else if (args.length === 1 && path.extname(args[0]) === '.json' && utils.file.isFile(args[0])) {
  options = utils._.extend(options, utils.file.readJSON(args[0]));
} else {
  options.source = args;
}

commentjs = new Commentjs(options);
data = commentjs.run();

if (data) {
  viewoptions = {
    filemap: commentjs.filemap,
    data: data,
    prettify: true
  };

  if (options.output) {
    viewoptions.output = options.output;
  }

  if (options.title) {
    viewoptions.title = options.title;
  }

  view = new View(viewoptions);

  view.render(function () {
    utils.log.ok('Rendered!');
  });
}
